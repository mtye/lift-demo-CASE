 * Notes for Step 0

The pom.xml file and the contents of the src directory were generated by Maven
using the following command:

  mvn archetype:generate -U -DarchetypeGroupId=net.liftweb \
                            -DarchetypeArtifactId=lift-archetype-basic \
                            -DarchetypeVersion=2.0-M3

And specifying:

  "com.marktye"      for the groupId,
  "lift-demo-CASE"   for the artifactId,
  "1.0-SNAPSHOT"     for the version, and
  "com.marktye.rhcp" for the package.

The Maven-generated web application can be compiled and executed with the
command:

  mvn jetty:run


 * Notes for Step 1

As a precursor to developing the Giveaway application, some of the artifacts
generated by the Maven archetype were deleted or changed.

The application does not serve any static files, so the "static" directory
under src/main/webapp was deleted, along with the corresponding menu entry in
the Boot.scala file.

The "lift-archetype-basic" archetype uses the artifactId specified in the
generation process to customize several elements of the application's "chrome",
e.g., the home page, the default page title, and the header. The artifactId
used in this case, "lift-demo-CASE", is somewhat inelegant, so the default
template and home page were changed to use the title "RHCP" instead.


 * Notes for Step 2

The first feature for the Giveaway application is a page for creating new
giveaways. A template named "create.html" was created in the
"src/main/webapp/giveaway" directory. This template uses the "lift:surround"
tag to embed its content within the default template, thus retaining the same
layout, styling, and menu as the home page.

The "<lift:Giveaway.create>" tag in the template references a method named
"create" in the "Giveaway" snippet, which is in the com.marktye.rhcp.snippet
package. This method binds dynamic content to tags within the
"<lift:Giveaway.create>" tag. The "<g:name>" tag is bound to an "input" form
element of type "text", the "<g:description>" tag is bound to a "textarea"
form element, and the "<g:submit>" tag is bound to a submit button.

The form elements are generated with the net.liftweb.http.SHtml object, which
has a wide variety of helper methods for creating HTML markup. The second
parameter to the "text" and "textarea" methods is a function that will be
invoked when the form is submitted. These functions are used to capture the
values of the input and textarea elements and assign them to local variables.
The second parameter to the "submit" method is also a function that is invoked
when the form is submitted. It sends a success message to the notification area
below the menu and redirects the user to the home page.

Finally, a menu item for the new page was created in the Boot.scala file and
added to the list of menu entries. The menu item tells Lift to make the new
page accessible at a relative URL of "giveaway/create" and display a
corresponding menu link with the title "Create New Giveaway".


 * Notes for Step 3

In this step, a page was created to display the giveaways. A template named
"list.html" was created in the giveaway directory. Just as in the previous
chapter, the "lift:surround" tag embeds this template within the default
template.

The "<lift:Giveaway.list>" tag links the template to the "list" method in the
Giveaway snippet, which generates all the dynamic content within the tag. The
giveaways are displayed in an HTML table, with the name in the first column
and the description in the second column.

In order to display the giveaways, the application must keep track of them as
they are created. To do this, a Giveaway companion object was created and
given a variable that stores giveaways as a list of (String, String) pairs.
Since companion objects are singletons, this list of giveaways is accessible
to all instances of the Giveaway snippet.

The "create" method in the Giveaway snippet was modified to add each newly-
created giveaway to the companion object's list of giveaways. The method's
redirect was also changed to send the user to the giveaway list page after
each new giveaway is created.

In the "list" method, each giveaway in the companion object's list is mapped
to the result of a "bind" method, which binds the "<g:name/>" tag in the
template to the giveaway's name, and the "<g:description/>" tag to the
description. The "chooseTemplate" method in the bind sets the binding context
to the "<g:giveaways>" tag. The net result is that the content outside the
<g:giveaways> tag - i.e., the <table>, <thead> and <tbody> tags - is preserved
as-is, while the content inside the "<g:giveaways>" tag is repeated for
each giveaway in the list, with the name and description tags bound to the
appropriate value for each giveaway.

Finally, a menu item for the list page was added to the Boot.scala file. The
menu item has a title of "List Giveaways" and links to the relative URL
"giveaway/list".


 * Notes for Step 4

The "ifLoggedIn" test was added to the Boot.scala file. This test has a
function that yields "true" if the current User is logged in and "false"
otherwise, and a message that will be displayed in the notification area if a
user who is not logged in attempts to access a menu item protected by the
test. The test is used to secure the "Create New Giveaway" and "List Giveaway"
pages.


 * Notes for Step 5

One unfortunate consequence of storing the list of giveaways in a singleton
object is that the list is lost when the server shuts down. To fix this
shortcoming, a mapper class named "Giveaway" was created in the
com.marktye.rhcp.model package. This class enables Giveaway instances to be
persisted to and retrieved from a SQL database - in this case, Lift's default
H2 database.

The Giveaway class extends the LongKeyedMapper trait, which enables some basic
persistence functionality and indicates that the primary key will be of type
Long. The IdPK trait provides a default primary key, a field named "id" that
maps to a database table column also named "id".

The Mapper trait defines an abstract method named "getSingleton" that
subclasses must implement to provide a reference to a MetaMapper object. The
Giveaway class's getSingleton method refers to its own companion object, which
must also extend the Giveaway class itself in order to satisfy the MetaMapper
trait's self-type requirements.

The Giveaway's "name" and "description" fields are inner singleton objects
that extend the MappedText and MappedTextarea classes, respectively. A Mapper's
data fields must extend the MappedField trait, and Lift provides a number of
convenience classes such as MappedText and MappedTextarea for mapping various
SQL data types to a variety of different Scala types.

The Giveaway snippet was changed to use this new Giveaway mapper class instead
of the singleton object's list. In the "create" method, the name and
description variables were replaced with a new instance of the Giveaway class,
which is saved to the database when the form is submitted. The binding of the
"name" and "description" tags was changed to form elements generated by the
"toForm" helper on name and description fields. The "toForm"-generated elements
are populated with the value of the underlying field, and when the value of the
form element changes, the underlying field is updated with the new value.

In the "list" method, the companion object's list of giveaways was replaced
with a call to the "findAll" method on the Giveaway meta-object. The findAll
method retrieves a list of all Giveaways that have been saved in the database.
Each Giveaway is bound to the contents of the "giveaways" tag, and the "name"
and "description" tags are bound to the corresponding fields of the Giveaway.

The Giveaway companion object was deleted, since the list of (name,
description) pairs is no longer needed.

Finally, the Giveaway class was added to the list of Mapper classes managed by
the Schemifier in Boot.scala. The Schemifier runs at server startup and
automatically modifies the database schema to ensure that the tables and
columns required by each Mapper class are present.


 * Notes for Step 6

This step establishes a relationship between the creator of a giveaway and the
currently logged-in user. A new "giver" field was added to the Giveaway mapper
class. The "giver" field extends MappedLongForeignKey, creating a many-to-one
relationship with the "User" mapper class, which was generated by the Maven
archetype in Step 0. The "giver" field has a convenience method named "name"
to simplify access to User's "shortName" method.

The "create" method of the Giveaway snippet was modified to assign the
currently logged-in user to the giver field when the form is submitted. Also,
in the "list" method, a new binding was added between the "giver" tag and the
result of each giveaway's giver's "name" method.

In the "list" template, a new column was added to the table to display the
giver's name with the new "<g:giver>" tag.


 * Notes for Step 7

In this step, users were given the ability to enter or withdraw from a
giveaway. This required establishing a many-to-many relationship between Users
and Giveaways.

A mapper class named "Entrant" was created with two fields: user and giveaway.
The "user" field creates a many-to-one relationship with the User mapper
class, and the "giveaway" field creates a many-to-one relationship with the
Giveaway mapper. Each Entrant thus represents a combination of a user and a
giveaway. This combination needs to be unique - otherwise, a user could enter
a giveaway multiple times - so a UniqueIndex was created and added to list of
dbIndexes on the Entrant companion object to enforce the uniqueness of each
user-giveaway combination.

The "entrants" field was added to the Giveaway mapper class. The entrants
field extends MappedManyToMany, and is parameterized with the mapper class
that holds the many-to-many relationship (Entrant), the field on Entrant that
holds a reference to this mapper class (Entrant.giveaway), the field that
holds a reference to the other side of the many-to-many relationship
(Entrant.user), and the mapper class on the other side of the many-to-many
(User).

The "entrants" fields of the Giveaway mapper has a helper method named
"containsCurrentUser" that determines whether the currently logged-in user is
entered in the giveaway. This method takes advantage of the fact that
MappedManytoMany implements the Collection trait. If a user is logged in, the
method checks whether the collection of entrants contains that user. If no
user is logged in, it returns "false" by default.

Two more helper methods named "enterCurrentUser" and "withdrawCurrentUser"
were added to Giveaway to facilitate adding and removing the currently
logged-in user from the collection of entrants. The "save" operation persists
the modified collection after the user has been added or removed.

To enable users to enter or withdraw from a giveaway, the "enterButton" and
"withdrawButton" methods were added. These methods generate submit buttons
that can be inserted into an HTML form and, when clicked, call the appropriate
method on a reloaded version of the giveaway to add or remove the current user
from the collection of entrants. The giveaway is reloaded from the database
because the collection of entrants might change during the interval between
the generation of a button and when it is clicked - most likely because the
same user has multiple browser windows or tabs open, or resubmits a form POST.
These methods also take as a parameter a function that will be executed after
the current user is entered or withdrawn. This can be used, among other
things, to specify a message to be displayed in the notification area.

The new "status" method checks whether the currently logged-in user is entered
in the giveaway and returns the appropriate type of submit button - "Withdraw"
for entered users, "Enter" for users who are not entered - that allows users to
change their status.

A new binding was added to the list method in the Giveaway snippet, binding
the "status" tag to the status method on the Giveaway mapper. The status
method is given one notice to be displayed if the user is entering the
giveaway, and another if the user is withdrawing.

The list template was modified to allow users to enter or withdraw from the
displayed giveaways. A column was added to the table to display a "status"
button for each giveaway, and the form="POST" attribute was added to the
"Giveaway.list" tag to enable the use of form elements (like submit buttons)
within the tag.

Finally, the Entrant class was added to the list of mappers managed by the
Schemifier in the Boot.scala file.


 * Notes for Step 8

This step added a detail page that can display more information for each
giveaway than a row on the giveaway list page.

A template named "detail.html" was created in the giveaway directory. The
template contains a "<lift:Giveaway.detail>" tag that links to the "detail"
method in the Giveaway snippet. The detail method looks for a parameter named
"id" in the HTTP request and queries the database for a giveaway with a key
that matches the parameter value. If a matching giveaway is found, the "name",
"giver", and "description" tags are bound to the corresponding fields on the
giveaway, and the "entrants" tag is bound to a method that will generate a
"entrant" tag for each user entered in the giveaway. If no matching giveaway
is found, text explaining the reason for no match is displayed instead.

The "list" method in the Giveaway snippet was changed to bind the "name" tag
to a link to the detail page for that particular giveaway. The link is
generated by the "link" method in the Giveaway mapper class, which constructs
a REST-style URL of the form "/detail/nnn", where "nnn" is the id field of the
giveaway.

In the Boot.scala file, a new menu entry was added for the detail page. The
menu entry contains the "Hidden" keyword to prevent a link to the detail page
from appearing on the site's menu.

Also, a new stateless rewrite was added to the LiftRules in the Boot.scala
file. The rewrite strips the id value from the end of URLs generated by the
Giveaway mapper's "link" method and assigns it to an HTTP parameter (also
named "id") that the Giveaway snippet's detail method uses to retrieve the
appropriate giveaway from the database.


 * Notes for Step 9

In this step, the creator of a giveaway was given the ability to choose a
winner at random from among the entrants.

A helper method named "isCurrentUser" was added to the "giver" field of the
Giveaway mapper class to determine whether the currently logged-in user is the
creator of the giveaway.

A helper method named "random" was added to the "entrants" field of the
Giveaway mapper class to enable the selection of a random entrant. The method
returns either an Option containing a randomly-selected entrant, or None if
no users have entered the giveaway.

A new field named "winner" was added to the Giveaway mapper class. The
"winner" field extends MappedLongForeignKey, creating a many-to-one
relationship between the Giveaway and User mapper classes, just like the
"giver" field. The user assigned to this field is deemed to have "won" the
giveaway. As with the "giver" field, "winner" has a helper method for
accessing the winning user's name. It also has an "isCurrentUser" method that
determines whether the currently logged-in user is the winner of the giveaway,
and a "notChosenYet" method that determines whether no winner has been
chosen yet. If no user has been assigned to the "winner" field, the field's
"choose" method assigns a randomly-selected entrant to the field and saves the
it to the database.

The "enterCurrentUser" and "withdrawCurrentUser" methods of the Giveaway
mapper were modified to prevent a user from entering or withdrawing from a
giveaway after a winner has been chosen.

A "randomEntrant" method was added to the Giveaway mapper to facilitate the
selection of a winner for the giveaway. It returns a user selected at random
from among the giveaway's entrants, or if the giveaway has no entrants, it
returns the user who created the giveaway.

The "status" method of the Giveaway mapper was modified to prevent users from
entering or withdrawing from a contest after a winner has been chosen. If no
winner has been chosen yet, the method returns, as it did before, a submit
button that either enters or withdraws the user from the giveaway. After a
winner has been chosen, though, it returns a text element indicating whether
the user has won, lost, or never entered the giveaway.

A "chooseWinner" method was added to the Giveaway mapper to generate an HTML
form element for displaying the winner's name or allowing the giver to choose
a winner at random. If the currently logged-in user is the giver and no winner
has yet been chosen, the method returns a submit button that will choose a
winner at random when clicked. Otherwise, it returns a text element containing
either the winner's name or a non-breaking space if no winner has been chosen
yet.

A "chooseWinnerButton" method was added to the Giveaway mapper to generate a
submit button for choosing a random winner. When clicked, the button chooses a
randomly-selected winner from among the giveaway's entrants and then calls the
function that was passed to it as a parameter.

A random number generator was added to the Giveaway companion object to
facilitate the selection of random entrants.

The detail template was modified to display the giveaway's winner and allow
the giver to select a winner at random. A "winner" tag was added to the
template, and the "detail" method of the Giveaway snippet was modified to bind
the "winner" tag to the Giveaway mapper class's "chooseWinner" method, which
generates a form element that either displays the winner's name or allows the
user to randomly select a winner. The binding passes a function to
"chooseWinner" that displays a message in the notification area when a winner
is chosen.


 * Notes for Step 10

This step added a "deadline" field to each giveaway, specifying a time after
which a winner will be automatically chosen and no more entrants can be added
or withdrawn. This could have been accomplished with Lift's MappedDateTime
class, but that would have required the user to enter the deadline as a text
string. Instead, a custom MappedField class was created to display dates in
formats like "37 seconds from now", "2 hours ago", "5 days, 2 hours, 10
minutes from now", and simplify the input of dates with the use of a drop-down
list.

The RelativeDateFormat class was created in the com.marktye.rhcp.text package,
extending the java.text.DateFormat abstract class. Its "format" method
calculates the number of milliseconds between the date being formatted and a
reference epoch, which defaults to the current time if none is specified. The
milliseconds are partitioned into units of time, which, if not specified,
default to "year, month, week, day, hour, minute, second". The string
representations of the units of time are concatenated together and either
"ago" or "from now" is appended to the result, depending on whether the date
precedes or follows the epoch.

The MappedRelativeDate class was created in the com.marktye.rhcp.mapper
package to facilitate the persistence of relative dates like "5 minutes from
now" and "2 weeks ago" in the database. The "toForm" method generates a text
input element for entering time quantities and a select element for specifying
units of time. On form submission, the value of the underlying Date is
calculated by adding or subtracting the specified amount of time from the
current time. The "shortFormat" method uses the RelativeDateFormat to display
the underlying Date in relative terms, using only the most significant unit -
i.e. "2 hours ago" if the date is 2 hours, 14 minutes and 35 seconds in the
past.

A "deadline" field extending MappedRelativeDate was added to the Giveaway
mapper class. The "deadline" field has "hasPassed" and "hasNotPassed" methods
for determining whether the deadline is before or after the current time.

The "name" method of the "winner" field of the Giveaway mapper was modified to
select a random winner, if possible, before returning the winner's name.
Similarly, the field's "isCurrentUser" method was modified to select a winner
before determining whether the currently logged-in user is the winner. The
field's "choose" method was modified to only select a random winner after the
deadline has passed.

The "enterCurrentUser" and "withdrawCurrentUser" methods of the Giveaway
mapper were modified to prevent users from entering or withdrawing from the
giveaway after the deadline.

The "status" method of the Giveaway mapper was similarly modified to only
return an "enter" or "withdraw" submit button before the deadline. After the
deadline has passed, it returns a "Won", "Lost", or "Not Entered" text
element.

The "chooseWinner" and "chooseWinnerButton" methods were deleted from the
Giveaway mapper, since the winner is now automatically selected after the
deadline passes, rather than when the giver clicks a form submit button.

The deadline was added to the "create", "list", and "detail" templates by
adding a "<g:deadline>" tag to each template. The tag in the "create" template
was bound to the deadline field's generated form elements in the "create"
method of the Giveaway snippet. The tag in the the "list" template was added
to a new column in the table and bound to the deadline field's "shortFormat"
method in the "list" method of the Giveaway snippet. The "detail" template's
tag was bound to the field's "shortFormat" method in the "detail"
method of the Giveaway snippet.

Finally, the binding of the "winner" tag in the detail method of the Giveaway
snippet was changed to the winner field's "name" method, defaulting to a
non-breaking space if no winner has been chosen yet.


 * Copyright and License

Copyright © 2010 Mark Tye

This work is licensed under the Creative Commons Attribution-Noncommercial-Share
Alike 3.0 United States License. To view a copy of this license, visit

  http://creativecommons.org/licenses/by-nc-sa/3.0/us/
